<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾æ¥­ç§è—æ‰‹å¸³</title>
    <style>
        :root {
            --gold: #D4AF37; --dark-gold: #8A6D3B; --bright-gold: #FFD700;
            --bg-black: #050505; --card-bg: #111111;
        }

        .luxury-back-btn {
            position: fixed; top: 20px; left: 20px; z-index: 9999;
            display: flex; align-items: center; gap: 8px; padding: 10px 18px;
            background: rgba(8, 8, 8, 0.8); border: 1px solid var(--gold);
            border-radius: 30px; color: var(--gold); text-decoration: none;
            font-size: 0.9rem; font-weight: bold; backdrop-filter: blur(10px);
        }

        body { 
            background-color: #000; color: var(--gold); font-family: -apple-system, "PingFang TC", sans-serif; 
            margin: 0; padding: 80px 15px 80px 15px; 
        }

        .page { display: none; animation: fadeIn 0.4s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h1 { color: var(--gold); text-align: center; font-size: 20px; margin: 10px 0; letter-spacing: 2px; }
        .form-group { margin-bottom: 8px; }
        label { display: block; color: var(--gold); font-size: 14px; margin-bottom: 3px; font-weight: bold; }
        
        input, select, textarea {
            width: 100%; padding: 10px; background-color: #000;
            border: 1px solid var(--dark-gold); border-radius: 10px; color: #fff; 
            font-size: 16px; box-sizing: border-box; outline: none;
        }

        .price-input { color: #00FF00; font-weight: bold; border-color: #006400; }
        .btn-save {
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            color: #000; border: none; border-radius: 25px; font-size: 18px; font-weight: bold; margin-top: 10px;
            cursor: pointer;
        }
        .btn-save:disabled { background: #444; color: #888; cursor: not-allowed; }

        .drawer { background: var(--card-bg); border: 1px solid #222; margin-bottom: 12px; border-radius: 12px; overflow: hidden; }
        .drawer-header { padding: 12px; cursor: pointer; background: #1a1a1a; }
        .drawer-header h3 { margin: 0; font-size: 18px; color: var(--bright-gold); }
        .drawer-content { display: none; padding: 12px; background: #080808; border-top: 1px solid #333; }
        .drawer.open .drawer-content { display: block; }

        .record-item { padding: 10px; margin-bottom: 10px; background: #151515; border-radius: 8px; border: 1px solid #222; }

        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; display: flex; height: 65px; border-top: 1px solid var(--dark-gold); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; cursor: pointer; }
        .nav-item.active-nav { color: var(--bright-gold); }
    </style>
</head>
<body>

    <a href="index.html" class="luxury-back-btn"><span>ğŸ </span> è¿”å›é¦–é </a>

    <div id="page1" class="page active">
        <h1>ç¾æ¥­å®¢æˆ¶ç®¡ç†</h1>
        <div id="search-tip" style="font-size:12px; text-align:center; color: var(--bright-gold); height:15px; margin-bottom:5px;"></div>
        
        <div style="display: flex; gap: 8px;">
            <div class="form-group" style="flex:1;"><label>è²´è³“å§“å</label><input type="text" id="name"></div>
            <div class="form-group" style="flex:1.5;"><label>è¯ç¹«é›»è©±</label><input type="tel" id="phone"></div>
        </div>
        
        <div style="display: flex; gap: 8px;">
            <div class="form-group" style="flex:1;"><label>è¡€å‹</label><select id="blood"><option value="">é¸æ“‡</option><option>Aå‹</option><option>Bå‹</option><option>Oå‹</option><option>ABå‹</option></select></div>
            <div class="form-group" style="flex:1;"><label>æ˜Ÿåº§</label><select id="constellation"><option value="">é¸æ“‡</option><option>ç‰¡ç¾Šåº§</option><option>é‡‘ç‰›åº§</option><option>é›™å­åº§</option><option>å·¨èŸ¹åº§</option><option>ç…å­åº§</option><option>è™•å¥³åº§</option><option>å¤©ç§¤åº§</option><option>å¤©è åº§</option><option>å°„æ‰‹åº§</option><option>æ‘©ç¾¯åº§</option><option>æ°´ç“¶åº§</option><option>é›™é­šåº§</option></select></div>
        </div>

        <div class="form-group"><label>æœ¬æ¬¡æ¶ˆè²»é …ç›®</label><input type="text" id="thisItem" placeholder="å¦‚ï¼šéœ§çœ‰ã€æ·±å±¤æ´—é«®"></div>
        <div class="form-group"><label>æ“ä½œç´€éŒ„</label><textarea id="thisLog" rows="2" placeholder="ä½¿ç”¨çš„è‰²è™Ÿã€æ²åº¦ç­‰..."></textarea></div>
        <div class="form-group"><label>æ¶ˆè²»é‡‘é¡ ($)</label><input type="number" id="price" class="price-input" placeholder="0"></div>
        
        <div class="form-group"><label>æé†’ä¸‹æ¬¡é …ç›®</label><input type="text" id="bookItem"></div>
        <div class="form-group"><label>ä¸‹æ¬¡é ç´„æ™‚é–“</label><input type="datetime-local" id="bookTime"></div>
        <div class="form-group"><label>å¿ƒå¾—å‚™è¨»</label><textarea id="note" rows="2"></textarea></div>
        
        <button class="btn-save" id="btnSave">ç¢ºèªå„²å­˜è‡³é›²ç«¯</button>
    </div>

    <div id="page2" class="page">
        <h1>é›²ç«¯æª”æ¡ˆç¸½è¦½</h1>
        <input type="text" id="keyword" placeholder="ğŸ” æœå°‹å§“åæˆ–é›»è©±..." style="margin-bottom:15px; width:100%;">
        <div id="list-container">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="nav">
        <div class="nav-item active-nav" id="nav1" onclick="showPage(1)"><span style="font-size:22px;">ğŸ’</span><span>è³‡æ–™ç™»è¨˜</span></div>
        <div class="nav-item" id="nav2" onclick="showPage(2)"><span style="font-size:22px;">ğŸ“œ</span><span>åå–®ç¸½è¦½</span></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // æ‚¨çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyAM4d9GqtSjNOlfguew8BktZ8ptrnBzvpc",
            authDomain: "mentor-app-b76e3.firebaseapp.com",
            projectId: "mentor-app-b76e3",
            storageBucket: "mentor-app-b76e3.firebasestorage.app",
            messagingSenderId: "757249551762",
            appId: "1:757249551762:web:512533e0a85dc1ad47654b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ç™»å…¥æª¢æŸ¥
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "index.html";
            } else {
                renderList(); 
            }
        });

        // 1. è‡ªå‹•æœå°‹èˆŠå®¢
        document.getElementById('name').onblur = async () => {
            const name = document.getElementById('name').value.trim();
            if (!name) return;
            
            const q = query(collection(db, "customer_logs"), where("name", "==", name));
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
                const lastData = querySnapshot.docs[0].data();
                document.getElementById('phone').value = lastData.phone || '';
                document.getElementById('blood').value = lastData.blood || '';
                document.getElementById('constellation').value = lastData.constellation || '';
                document.getElementById('search-tip').innerText = "â­ å·²è‡ªå‹•æŠ“å–èˆŠå®¢è³‡æ–™";
            } else {
                document.getElementById('search-tip').innerText = "ğŸ†• æ–°å®¢æˆ¶ç™»è¨˜";
            }
        };

        // 2. å„²å­˜é‚è¼¯ (ä¿®æ­£å¾Œ)
        const btnSave = document.getElementById('btnSave');
        btnSave.addEventListener('click', async () => {
            const name = document.getElementById('name').value.trim();
            if (!name) return alert("è«‹å¡«å¯«å§“å");

            btnSave.disabled = true;
            btnSave.innerText = "åŒæ­¥ä¸­...";

            try {
                await addDoc(collection(db, "customer_logs"), {
                    name: name,
                    phone: document.getElementById('phone').value,
                    thisItem: document.getElementById('thisItem').value,
                    thisLog: document.getElementById('thisLog').value,
                    price: document.getElementById('price').value,
                    blood: document.getElementById('blood').value,
                    constellation: document.getElementById('constellation').value,
                    bookItem: document.getElementById('bookItem').value,
                    bookTime: document.getElementById('bookTime').value,
                    note: document.getElementById('note').value,
                    saveTime: new Date().getTime() // ä½¿ç”¨ timestamp æ’åºæ›´ç²¾æº–
                });
                alert("æ­¸æª”æˆåŠŸï¼");
                location.reload(); 
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("å„²å­˜å¤±æ•—ï¼š" + e.message);
                btnSave.disabled = false;
                btnSave.innerText = "ç¢ºèªå„²å­˜è‡³é›²ç«¯";
            }
        });

        // 3. å¯¦æ™‚æ¸²æŸ“åå–®
        function renderList() {
            const q = query(collection(db, "customer_logs"), orderBy("saveTime", "desc"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('list-container');
                container.innerHTML = "";
                
                const groups = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!groups[data.name]) groups[data.name] = [];
                    groups[data.name].push(data);
                });

                for (const name in groups) {
                    const records = groups[name];
                    const latest = records[0];
                    const drawer = document.createElement('div');
                    drawer.className = 'drawer';
                    drawer.innerHTML = `
                        <div class="drawer-header">
                            <h3>ğŸ‘¤ ${name}</h3>
                            <div style="font-size:12px; color:#888;">æœ€æ–°ï¼š${latest.thisItem} | $${latest.price}</div>
                        </div>
                        <div class="drawer-content">
                            ${records.map(r => `
                                <div class="record-item">
                                    <div style="font-size:11px; color:#555;">ğŸ•’ ${new Date(r.saveTime).toLocaleString()}</div>
                                    <div style="color:var(--gold);">ğŸ›ï¸ ${r.thisItem} ($${r.price})</div>
                                    <div style="font-size:14px; color:#ddd;">ğŸ“ ${r.thisLog}</div>
                                    <div style="font-size:12px; color:var(--bright-gold); margin-top:5px;">ğŸ”” ä¸‹æ¬¡ï¼š${r.bookItem || 'ç„¡'}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    // ç¶å®šé»æ“Šäº‹ä»¶å±•é–‹æŠ½å±œ
                    drawer.querySelector('.drawer-header').onclick = () => drawer.classList.toggle('open');
                    container.appendChild(drawer);
                }
            });
        }
    </script>

    <script>
        // UI åˆ†é é‚è¼¯ (æ”¾åœ¨ä¸€èˆ¬ script ç¢ºä¿å…¨åŸŸå¯ç”¨)
        function showPage(num) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page' + num).classList.add('active');
            document.getElementById('nav1').classList.toggle('active-nav', num === 1);
            document.getElementById('nav2').classList.toggle('active-nav', num === 2);
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>

